# èº«ä»½è®¤è¯ä¸­å¿ƒ (Identity Service) è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [æœåŠ¡æ¦‚è¿°](#æœåŠ¡æ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
- [API æ¥å£](#api-æ¥å£)
- [éƒ¨ç½²é…ç½®](#éƒ¨ç½²é…ç½®)
- [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)
- [è¿ç»´ç›‘æ§](#è¿ç»´ç›‘æ§)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

---

## æœåŠ¡æ¦‚è¿°

### ğŸ¯ æœåŠ¡èŒè´£
èº«ä»½è®¤è¯ä¸­å¿ƒåŸºäº Keycloak æä¾›ç»Ÿä¸€çš„èº«ä»½è®¤è¯ä¸æˆæƒæœåŠ¡ï¼Œæ˜¯æ•´ä¸ª SmartHub å¹³å°çš„å®‰å…¨åŸºçŸ³ã€‚

### ğŸ’¡ æ ¸å¿ƒä»·å€¼
- **ç»Ÿä¸€è®¤è¯**: ä¸ºæ‰€æœ‰å¾®æœåŠ¡æä¾›ç»Ÿä¸€çš„èº«ä»½éªŒè¯
- **OAuth 2.0 é›†æˆ**: æ”¯æŒ Googleã€Amazonã€å¾®ä¿¡ç­‰ç¬¬ä¸‰æ–¹å¹³å°ç™»å½•
- **å¤šç§Ÿæˆ·æ”¯æŒ**: æ”¯æŒä¼ä¸šçº§å¤šç§Ÿæˆ·æ¶æ„
- **ç»†ç²’åº¦æƒé™**: åŸºäºè§’è‰²å’Œèµ„æºçš„è®¿é—®æ§åˆ¶

### ğŸ”— æœåŠ¡ä¾èµ–
- **ç‹¬ç«‹æ•°æ®åº“**: PostgreSQL (keycloak_db)
- **æ— ä¸Šæ¸¸ä¾èµ–**: ä½œä¸ºåŸºç¡€æœåŠ¡ï¼Œä¸ä¾èµ–å…¶ä»–ä¸šåŠ¡æœåŠ¡

---

## æ¶æ„è®¾è®¡

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å¤–éƒ¨èº«ä»½æä¾›è€…"
        Google[Google OAuth]
        Amazon[Amazon OAuth]
        WeChat[å¾®ä¿¡ç™»å½•]
        GitHub[GitHub OAuth]
    end
    
    subgraph "Keycloak èº«ä»½ä¸­å¿ƒ"
        KC[Keycloak Server]
        Realm[SmartHome Realm]
        IDP[Identity Providers]
        Users[User Federation]
    end
    
    subgraph "å®¢æˆ·ç«¯åº”ç”¨"
        GH[Google Home Integration]
        Alexa[Alexa Skill]
        Mobile[Mobile App]
        Web[Web Dashboard]
    end
    
    subgraph "ä¸‹æ¸¸æœåŠ¡"
        Gateway[Protocol Gateway]
        Device[Device Service]
        Message[Message Service]
    end
    
    subgraph "æ•°æ®å­˜å‚¨"
        DB[(PostgreSQL<br/>keycloak_db)]
        Cache[(Redis<br/>Session Cache)]
    end
    
    Google --> IDP
    Amazon --> IDP
    WeChat --> IDP
    GitHub --> IDP
    
    IDP --> Realm
    Realm --> KC
    Users --> KC
    
    GH --> KC
    Alexa --> KC
    Mobile --> KC
    Web --> KC
    
    KC --> Gateway
    KC --> Device
    KC --> Message
    
    KC --> DB
    KC --> Cache
```

### ğŸ“¦ éƒ¨ç½²æ¶æ„

```mermaid
graph LR
    subgraph "Load Balancer"
        LB[Nginx/HAProxy]
    end
    
    subgraph "Keycloak Cluster"
        KC1[Keycloak Instance 1]
        KC2[Keycloak Instance 2]
        KC3[Keycloak Instance 3]
    end
    
    subgraph "Database Cluster"
        Master[(PostgreSQL Master)]
        Slave1[(PostgreSQL Slave 1)]
        Slave2[(PostgreSQL Slave 2)]
    end
    
    subgraph "Cache Cluster"
        Redis1[(Redis Master)]
        Redis2[(Redis Slave)]
    end
    
    LB --> KC1
    LB --> KC2
    LB --> KC3
    
    KC1 --> Master
    KC2 --> Master
    KC3 --> Master
    
    Master --> Slave1
    Master --> Slave2
    
    KC1 --> Redis1
    KC2 --> Redis1
    KC3 --> Redis1
    
    Redis1 --> Redis2
```

---

## æ ¸å¿ƒåŠŸèƒ½

### ğŸ” èº«ä»½è®¤è¯åŠŸèƒ½

#### 1. å¤šç§è®¤è¯æ–¹å¼
```yaml
authentication_methods:
  password:
    enabled: true
    policy:
      min_length: 8
      require_uppercase: true
      require_numbers: true
      require_special_chars: true
      
  oauth2:
    providers:
      - google
      - amazon
      - github
      - wechat
      
  two_factor:
    enabled: true
    methods:
      - totp
      - sms
      - email
      
  social_login:
    auto_account_linking: true
    email_verification_required: true
```

#### 2. OAuth 2.0 é›†æˆé…ç½®
```json
{
  "clients": [
    {
      "clientId": "google-smart-home",
      "clientSecret": "${GOOGLE_CLIENT_SECRET}",
      "protocol": "openid-connect",
      "redirectUris": [
        "https://oauth-redirect.googleusercontent.com/r/YOUR_PROJECT_ID"
      ],
      "webOrigins": ["https://assistant.google.com"],
      "standardFlowEnabled": true,
      "implicitFlowEnabled": false,
      "serviceAccountsEnabled": false,
      "attributes": {
        "saml.assertion.signature": "false",
        "saml.force.post.binding": "false",
        "saml.multivalued.roles": "false",
        "saml.encrypt": "false"
      }
    },
    {
      "clientId": "alexa-smart-home",
      "clientSecret": "${ALEXA_CLIENT_SECRET}",
      "protocol": "openid-connect",
      "redirectUris": [
        "https://pitangui.amazon.com/api/skill/link/YOUR_SKILL_ID",
        "https://alexa.amazon.co.jp/api/skill/link/YOUR_SKILL_ID"
      ],
      "webOrigins": ["https://alexa.amazon.com"],
      "standardFlowEnabled": true
    }
  ]
}
```

### ğŸ‘¥ ç”¨æˆ·ç®¡ç†åŠŸèƒ½

#### 1. å¤šç§Ÿæˆ·æ¶æ„
```yaml
tenant_management:
  isolation_level: "realm"  # æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹ Realm
  
  tenant_creation:
    auto_provisioning: true
    default_roles: ["user", "device_owner"]
    default_groups: ["home_users"]
    
  user_attributes:
    custom_fields:
      - tenant_id
      - subscription_plan
      - device_limit
      - preferred_language
      - timezone
```

#### 2. è§’è‰²æƒé™ç³»ç»Ÿ
```json
{
  "roles": {
    "realm_roles": [
      {
        "name": "admin",
        "description": "ç³»ç»Ÿç®¡ç†å‘˜",
        "composite": true,
        "composites": {
          "realm": ["user", "device_admin", "tenant_admin"]
        }
      },
      {
        "name": "device_admin",
        "description": "è®¾å¤‡ç®¡ç†å‘˜",
        "attributes": {
          "device_limit": ["100"],
          "can_create_scenes": ["true"]
        }
      },
      {
        "name": "user",
        "description": "æ™®é€šç”¨æˆ·",
        "attributes": {
          "device_limit": ["50"],
          "can_create_scenes": ["true"]
        }
      },
      {
        "name": "guest",
        "description": "è®¿å®¢ç”¨æˆ·",
        "attributes": {
          "device_limit": ["0"],
          "can_create_scenes": ["false"]
        }
      }
    ],
    "client_roles": {
      "smart-gateway": [
        {
          "name": "platform_access",
          "description": "å¹³å° API è®¿é—®æƒé™"
        }
      ],
      "device-service": [
        {
          "name": "device_control",
          "description": "è®¾å¤‡æ§åˆ¶æƒé™"
        },
        {
          "name": "device_read",
          "description": "è®¾å¤‡çŠ¶æ€æŸ¥çœ‹æƒé™"
        }
      ]
    }
  }
}
```

### ğŸ”‘ JWT Token è®¾è®¡

#### 1. Token ç»“æ„
```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT",
    "kid": "realm-key-id"
  },
  "payload": {
    "iss": "https://auth.smarthub.com/realms/smarthome",
    "sub": "user-uuid-12345",
    "aud": ["smart-gateway", "device-service", "message-service"],
    "exp": 1735689600,
    "iat": 1735689000,
    "auth_time": 1735689000,
    "jti": "token-uuid-67890",
    
    "email": "user@example.com",
    "email_verified": true,
    "preferred_username": "johndoe",
    "given_name": "John",
    "family_name": "Doe",
    
    "tenant_id": "tenant-uuid-11111",
    "realm_access": {
      "roles": ["user", "device_admin"]
    },
    "resource_access": {
      "smart-gateway": {
        "roles": ["platform_access"]
      },
      "device-service": {
        "roles": ["device_control", "device_read"]
      }
    },
    
    "custom_claims": {
      "device_limit": 50,
      "subscription_plan": "premium",
      "preferred_language": "zh-CN",
      "timezone": "Asia/Shanghai"
    }
  }
}
```

#### 2. Token ç”Ÿå‘½å‘¨æœŸç®¡ç†
```yaml
token_settings:
  access_token:
    lifespan: 900  # 15 åˆ†é’Ÿ
    refresh_threshold: 300  # 5 åˆ†é’Ÿåˆ·æ–°é˜ˆå€¼
    
  refresh_token:
    lifespan: 86400  # 24 å°æ—¶
    idle_timeout: 3600  # 1 å°æ—¶ç©ºé—²è¶…æ—¶
    
  id_token:
    lifespan: 900  # 15 åˆ†é’Ÿ
    
  offline_token:
    enabled: true
    lifespan: 2592000  # 30 å¤©
```

---

## æ•°æ®æ¨¡å‹

### ğŸ“Š æ•°æ®åº“è®¾è®¡

#### 1. æ ¸å¿ƒè¡¨ç»“æ„
```sql
-- ç§Ÿæˆ·è¡¨ (Keycloak Realm æ‰©å±•)
CREATE TABLE tenant_metadata (
    realm_id VARCHAR(36) PRIMARY KEY,
    tenant_name VARCHAR(100) NOT NULL,
    subscription_plan VARCHAR(50) DEFAULT 'basic',
    device_limit INTEGER DEFAULT 50,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    status VARCHAR(20) DEFAULT 'active'
);

-- ç”¨æˆ·æ‰©å±•å±æ€§è¡¨
CREATE TABLE user_profiles (
    user_id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) REFERENCES tenant_metadata(realm_id),
    preferred_language VARCHAR(10) DEFAULT 'en',
    timezone VARCHAR(50) DEFAULT 'UTC',
    notification_preferences JSONB,
    device_preferences JSONB,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç¬¬ä¸‰æ–¹å¹³å°ç»‘å®šè¡¨
CREATE TABLE platform_user_bindings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR(36) NOT NULL,
    platform_id VARCHAR(50) NOT NULL,
    platform_user_id VARCHAR(100) NOT NULL,
    platform_username VARCHAR(100),
    access_token_encrypted TEXT,
    refresh_token_encrypted TEXT,
    token_expires_at TIMESTAMP,
    binding_status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(platform_id, platform_user_id)
);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE auth_audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR(36),
    session_id VARCHAR(100),
    event_type VARCHAR(50) NOT NULL,
    event_details JSONB,
    ip_address INET,
    user_agent TEXT,
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_profiles_tenant ON user_profiles(tenant_id);
CREATE INDEX idx_platform_bindings_user ON platform_user_bindings(user_id);
CREATE INDEX idx_platform_bindings_platform ON platform_user_bindings(platform_id, platform_user_id);
CREATE INDEX idx_audit_logs_user_time ON auth_audit_logs(user_id, created_at);
CREATE INDEX idx_audit_logs_event_type ON auth_audit_logs(event_type, created_at);
```

#### 2. Keycloak è‡ªå®šä¹‰ SPI
```java
// è‡ªå®šä¹‰ç”¨æˆ·å­˜å‚¨ SPI
@Component
public class SmartHubUserStorageProvider implements UserStorageProvider {
    
    @Override
    public UserModel getUserById(String id, RealmModel realm) {
        // ä»æ‰©å±•è¡¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        UserProfile profile = userProfileRepository.findByUserId(id);
        if (profile != null) {
            UserModel user = session.users().getUserById(id, realm);
            enrichUserWithProfile(user, profile);
            return user;
        }
        return null;
    }
    
    @Override
    public UserModel getUserByUsername(String username, RealmModel realm) {
        // å®ç°ç”¨æˆ·åæŸ¥è¯¢é€»è¾‘
    }
    
    private void enrichUserWithProfile(UserModel user, UserProfile profile) {
        user.setSingleAttribute("tenant_id", profile.getTenantId());
        user.setSingleAttribute("device_limit", String.valueOf(profile.getDeviceLimit()));
        user.setSingleAttribute("preferred_language", profile.getPreferredLanguage());
        user.setSingleAttribute("timezone", profile.getTimezone());
    }
}
```

---

## API æ¥å£

### ğŸŒ RESTful API

#### 1. æ ‡å‡† OAuth 2.0 ç«¯ç‚¹
```yaml
oauth_endpoints:
  authorization:
    url: GET /auth/realms/{realm}/protocol/openid-connect/auth
    parameters:
      - client_id: required
      - response_type: "code" | "token"
      - redirect_uri: required
      - scope: "openid profile email"
      - state: recommended
      
  token:
    url: POST /auth/realms/{realm}/protocol/openid-connect/token
    body:
      grant_type: "authorization_code" | "refresh_token"
      client_id: required
      client_secret: required
      code: required (for authorization_code)
      refresh_token: required (for refresh_token)
      
  userinfo:
    url: GET /auth/realms/{realm}/protocol/openid-connect/userinfo
    headers:
      Authorization: "Bearer {access_token}"
      
  jwks:
    url: GET /auth/realms/{realm}/protocol/openid-connect/certs
    description: "JWT éªŒç­¾å…¬é’¥"
```

#### 2. ç®¡ç† API
```yaml
admin_api:
  users:
    list_users:
      url: GET /auth/admin/realms/{realm}/users
      auth: admin_token
      
    create_user:
      url: POST /auth/admin/realms/{realm}/users
      body:
        username: string
        email: string
        firstName: string
        lastName: string
        enabled: boolean
        attributes:
          tenant_id: string
          device_limit: number
          
    update_user:
      url: PUT /auth/admin/realms/{realm}/users/{user-id}
      
    delete_user:
      url: DELETE /auth/admin/realms/{realm}/users/{user-id}
      
  platform_bindings:
    bind_platform:
      url: POST /auth/admin/realms/{realm}/users/{user-id}/platform-bindings
      body:
        platform_id: string
        platform_user_id: string
        access_token: string
        
    list_bindings:
      url: GET /auth/admin/realms/{realm}/users/{user-id}/platform-bindings
      
    unbind_platform:
      url: DELETE /auth/admin/realms/{realm}/users/{user-id}/platform-bindings/{platform-id}
```

#### 3. è‡ªå®šä¹‰æ‰©å±• API
```yaml
extension_api:
  tenant_management:
    create_tenant:
      url: POST /auth/api/v1/tenants
      body:
        name: string
        subscription_plan: string
        device_limit: number
        admin_email: string
        
    get_tenant_info:
      url: GET /auth/api/v1/tenants/{tenant-id}
      
    update_tenant:
      url: PUT /auth/api/v1/tenants/{tenant-id}
      
  user_profiles:
    get_profile:
      url: GET /auth/api/v1/users/{user-id}/profile
      
    update_profile:
      url: PUT /auth/api/v1/users/{user-id}/profile
      body:
        preferred_language: string
        timezone: string
        notification_preferences: object
        
  audit_logs:
    query_logs:
      url: GET /auth/api/v1/audit-logs
      parameters:
        user_id: optional
        event_type: optional
        start_time: optional
        end_time: optional
        limit: default 100
```

### ğŸ“¡ äº‹ä»¶å‘å¸ƒ

#### 1. Keycloak äº‹ä»¶ç›‘å¬å™¨
```java
@Component
public class SmartHubEventListener implements EventListenerProvider {
    
    @Override
    public void onEvent(Event event) {
        switch (event.getType()) {
            case LOGIN:
                handleUserLogin(event);
                break;
            case LOGOUT:
                handleUserLogout(event);
                break;
            case REGISTER:
                handleUserRegistration(event);
                break;
            case UPDATE_PROFILE:
                handleProfileUpdate(event);
                break;
        }
    }
    
    private void handleUserLogin(Event event) {
        // å‘å¸ƒç”¨æˆ·ç™»å½•äº‹ä»¶åˆ° NATS
        UserLoginEvent loginEvent = UserLoginEvent.builder()
            .userId(event.getUserId())
            .sessionId(event.getSessionId())
            .ipAddress(event.getIpAddress())
            .timestamp(Instant.ofEpochMilli(event.getTime()))
            .build();
            
        natsPublisher.publish("auth.user.login", loginEvent);
        
        // æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
        userProfileService.updateLastLogin(event.getUserId());
    }
}
```

#### 2. äº‹ä»¶æ¶ˆæ¯æ ¼å¼
```json
{
  "auth.user.login": {
    "user_id": "user-uuid-12345",
    "session_id": "session-uuid-67890",
    "tenant_id": "tenant-uuid-11111",
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0...",
    "platform": "google_home",
    "timestamp": "2024-01-01T12:00:00Z"
  },
  
  "auth.user.logout": {
    "user_id": "user-uuid-12345",
    "session_id": "session-uuid-67890",
    "logout_reason": "user_initiated",
    "timestamp": "2024-01-01T13:00:00Z"
  },
  
  "auth.platform.bound": {
    "user_id": "user-uuid-12345",
    "platform_id": "google",
    "platform_user_id": "google-user-123",
    "binding_status": "active",
    "timestamp": "2024-01-01T12:05:00Z"
  }
}
```

---

## éƒ¨ç½²é…ç½®

### ğŸ³ Docker éƒ¨ç½²

#### 1. Dockerfile
```dockerfile
FROM quay.io/keycloak/keycloak:26.0

# å¤åˆ¶è‡ªå®šä¹‰é…ç½®
COPY configs/realm-export.json /opt/keycloak/data/import/
COPY configs/themes/ /opt/keycloak/themes/smarthub/
COPY extensions/*.jar /opt/keycloak/providers/

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY scripts/start-keycloak.sh /opt/keycloak/bin/

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV KC_DB=postgres
ENV KC_FEATURES=token-exchange,admin-fine-grained-authz
ENV KC_LOG_LEVEL=INFO

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

EXPOSE 8080
ENTRYPOINT ["/opt/keycloak/bin/start-keycloak.sh"]
```

#### 2. Docker Compose é…ç½®
```yaml
version: '3.9'

services:
  keycloak:
    build: .
    container_name: smarthub-keycloak
    environment:
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HOSTNAME: auth.smarthub.com
      KC_HOSTNAME_STRICT: false
      KC_HTTP_ENABLED: true
      KC_PROXY: edge
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - keycloak-data:/opt/keycloak/data
    networks:
      - smarthub-network
    restart: unless-stopped
    
  postgres:
    image: postgres:16
    container_name: keycloak-postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - smarthub-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    
  redis:
    image: redis:7-alpine
    container_name: keycloak-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - smarthub-network
    restart: unless-stopped

volumes:
  keycloak-data:
  postgres-data:
  redis-data:

networks:
  smarthub-network:
    driver: bridge
```

### â˜¸ï¸ Kubernetes éƒ¨ç½²

#### 1. ConfigMap
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
  namespace: smarthub
data:
  realm-export.json: |
    {
      "realm": "smarthome",
      "enabled": true,
      "registrationAllowed": true,
      "resetPasswordAllowed": true,
      "rememberMe": true,
      "verifyEmail": true,
      "loginWithEmailAllowed": true,
      "duplicateEmailsAllowed": false,
      "accessTokenLifespan": 900,
      "ssoSessionIdleTimeout": 1800,
      "ssoSessionMaxLifespan": 36000,
      "offlineSessionIdleTimeout": 2592000,
      "accessCodeLifespan": 60,
      "clients": [
        {
          "clientId": "google-smart-home",
          "enabled": true,
          "protocol": "openid-connect",
          "standardFlowEnabled": true,
          "redirectUris": ["https://oauth-redirect.googleusercontent.com/r/*"]
        }
      ]
    }
```

#### 2. Deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: smarthub
spec:
  replicas: 3
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
      - name: keycloak
        image: smarthub/keycloak:latest
        env:
        - name: KC_DB_URL
          value: "jdbc:postgresql://postgres:5432/keycloak"
        - name: KC_DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: keycloak-secrets
              key: db-username
        - name: KC_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-secrets
              key: db-password
        - name: KEYCLOAK_ADMIN
          value: "admin"
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-secrets
              key: admin-password
        - name: KC_HOSTNAME
          value: "auth.smarthub.com"
        - name: KC_PROXY
          value: "edge"
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: realm-config
          mountPath: /opt/keycloak/data/import
        readinessProbe:
          httpGet:
            path: /realms/smarthome
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 120
          periodSeconds: 30
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: realm-config
        configMap:
          name: keycloak-config
```

---

## å®‰å…¨è®¾è®¡

### ğŸ”’ å®‰å…¨é…ç½®

#### 1. SSL/TLS é…ç½®
```yaml
tls_configuration:
  protocols:
    - TLSv1.3
    - TLSv1.2
  ciphers:
    - ECDHE-RSA-AES256-GCM-SHA384
    - ECDHE-RSA-AES128-GCM-SHA256
    - ECDHE-RSA-AES256-SHA384
  certificate:
    type: "letsencrypt"
    domains:
      - auth.smarthub.com
      - keycloak.smarthub.com
```

#### 2. å®‰å…¨ç­–ç•¥
```yaml
security_policies:
  password_policy:
    - length(8)
    - upperCase(1)
    - lowerCase(1)
    - digits(1)
    - specialChars(1)
    - notUsername
    - notEmail
    - regexPattern(^(?=.*[a-zA-Z])(?=.*[0-9]))
    
  brute_force_protection:
    enabled: true
    failure_factor: 30
    wait_increment: 60  # seconds
    quick_login_check_millis: 1000
    minimum_quick_login_wait: 60
    max_failure_wait: 900
    max_delta_time: 43200  # 12 hours
    
  session_management:
    session_timeout: 1800  # 30 minutes
    remember_me: true
    remember_me_timeout: 2592000  # 30 days
    concurrent_sessions: 5
```

#### 3. CORS é…ç½®
```yaml
cors_configuration:
  allowed_origins:
    - https://assistant.google.com
    - https://alexa.amazon.com
    - https://app.smarthub.com
    - https://dashboard.smarthub.com
  allowed_methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  allowed_headers:
    - Authorization
    - Content-Type
    - X-Requested-With
  exposed_headers:
    - X-Total-Count
  credentials: true
  max_age: 3600
```

### ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤

#### 1. æ•æ„Ÿæ•°æ®åŠ å¯†
```java
@Service
public class EncryptionService {
    
    private final AESUtil aesUtil;
    private final RSAUtil rsaUtil;
    
    @Value("${app.encryption.secret}")
    private String encryptionSecret;
    
    public String encryptSensitiveData(String data) {
        try {
            return aesUtil.encrypt(data, encryptionSecret);
        } catch (Exception e) {
            throw new EncryptionException("Failed to encrypt data", e);
        }
    }
    
    public String decryptSensitiveData(String encryptedData) {
        try {
            return aesUtil.decrypt(encryptedData, encryptionSecret);
        } catch (Exception e) {
            throw new EncryptionException("Failed to decrypt data", e);
        }
    }
    
    // JWT ç§é’¥ä¿æŠ¤
    public PrivateKey getJwtSigningKey() {
        return rsaUtil.loadPrivateKeyFromSecureStorage();
    }
}
```

#### 2. å®¡è®¡æ—¥å¿—
```java
@Component
public class SecurityAuditLogger {
    
    @EventListener
    public void handleAuthenticationEvent(AuthenticationEvent event) {
        AuditLog auditLog = AuditLog.builder()
            .eventType(event.getType())
            .userId(event.getUserId())
            .sessionId(event.getSessionId())
            .ipAddress(event.getIpAddress())
            .userAgent(event.getUserAgent())
            .success(event.isSuccess())
            .errorMessage(event.getErrorMessage())
            .timestamp(Instant.now())
            .build();
            
        auditLogRepository.save(auditLog);
        
        // æ£€æµ‹å¯ç–‘æ´»åŠ¨
        if (isSuspiciousActivity(event)) {
            alertService.sendSecurityAlert(auditLog);
        }
    }
    
    private boolean isSuspiciousActivity(AuthenticationEvent event) {
        // æ£€æµ‹é€»è¾‘ï¼š
        // 1. çŸ­æ—¶é—´å†…å¤šæ¬¡å¤±è´¥ç™»å½•
        // 2. å¼‚å¸¸åœ°ç†ä½ç½®ç™»å½•
        // 3. å¼‚å¸¸è®¾å¤‡ç™»å½•
        return false;
    }
}
```

---

## è¿ç»´ç›‘æ§

### ğŸ“Š ç›‘æ§æŒ‡æ ‡

#### 1. ä¸šåŠ¡æŒ‡æ ‡
```yaml
business_metrics:
  authentication:
    - keycloak_user_logins_total
    - keycloak_user_registrations_total
    - keycloak_failed_logins_total
    - keycloak_active_sessions_current
    - keycloak_token_requests_total
    - keycloak_token_refresh_total
    
  users:
    - keycloak_users_total
    - keycloak_users_online_current
    - keycloak_platform_bindings_total
    
  security:
    - keycloak_brute_force_attacks_total
    - keycloak_suspicious_activities_total
    - keycloak_admin_actions_total
```

#### 2. æŠ€æœ¯æŒ‡æ ‡
```yaml
technical_metrics:
  performance:
    - keycloak_request_duration_seconds
    - keycloak_db_connections_active
    - keycloak_db_connections_idle
    - keycloak_cache_hit_ratio
    - keycloak_memory_usage_bytes
    - keycloak_cpu_usage_percent
    
  availability:
    - keycloak_up
    - keycloak_db_up
    - keycloak_redis_up
    - keycloak_health_check_duration_seconds
```

#### 3. Prometheus é…ç½®
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'keycloak'
    static_configs:
      - targets: ['keycloak:8080']
    metrics_path: '/auth/realms/smarthome/metrics'
    scrape_interval: 30s
    
  - job_name: 'keycloak-postgres'
    static_configs:
      - targets: ['postgres:9187']
    scrape_interval: 30s
    
recording_rules:
  - name: keycloak.rules
    rules:
      - record: keycloak_login_success_rate
        expr: rate(keycloak_user_logins_total[5m]) / (rate(keycloak_user_logins_total[5m]) + rate(keycloak_failed_logins_total[5m]))
        
      - record: keycloak_avg_response_time
        expr: rate(keycloak_request_duration_seconds_sum[5m]) / rate(keycloak_request_duration_seconds_count[5m])
```

### ğŸš¨ å‘Šè­¦è§„åˆ™

#### 1. å…³é”®å‘Šè­¦
```yaml
# alerts/keycloak-critical.yml
groups:
- name: keycloak.critical
  rules:
  - alert: KeycloakDown
    expr: up{job="keycloak"} == 0
    for: 1m
    labels:
      severity: critical
      service: identity
    annotations:
      summary: "Keycloak instance is down"
      description: "Keycloak instance {{ $labels.instance }} has been down for more than 1 minute"
      
  - alert: KeycloakDatabaseDown
    expr: up{job="keycloak-postgres"} == 0
    for: 2m
    labels:
      severity: critical
      service: identity
    annotations:
      summary: "Keycloak database is unreachable"
      description: "Database connection has been down for more than 2 minutes"
      
  - alert: HighFailedLoginRate
    expr: rate(keycloak_failed_logins_total[5m]) > 10
    for: 3m
    labels:
      severity: critical
      service: identity
    annotations:
      summary: "High failed login rate detected"
      description: "Failed login rate is {{ $value }} per second"
      
  - alert: BruteForceAttack
    expr: increase(keycloak_brute_force_attacks_total[5m]) > 5
    for: 1m
    labels:
      severity: critical
      service: identity
    annotations:
      summary: "Potential brute force attack detected"
      description: "{{ $value }} brute force attempts in the last 5 minutes"
```

#### 2. æ€§èƒ½å‘Šè­¦
```yaml
# alerts/keycloak-performance.yml
groups:
- name: keycloak.performance
  rules:
  - alert: HighResponseTime
    expr: keycloak_avg_response_time > 2
    for: 5m
    labels:
      severity: warning
      service: identity
    annotations:
      summary: "High response time"
      description: "Average response time is {{ $value }}s"
      
  - alert: HighMemoryUsage
    expr: (keycloak_memory_usage_bytes / keycloak_memory_limit_bytes) > 0.8
    for: 5m
    labels:
      severity: warning
      service: identity
    annotations:
      summary: "High memory usage"
      description: "Memory usage is {{ $value | humanizePercentage }}"
      
  - alert: DatabaseConnectionPoolExhausted
    expr: keycloak_db_connections_active >= keycloak_db_connections_max * 0.9
    for: 2m
    labels:
      severity: warning
      service: identity
    annotations:
      summary: "Database connection pool nearly exhausted"
      description: "{{ $value }} active connections out of {{ $labels.max }}"
```

### ğŸ“ˆ Grafana ä»ªè¡¨æ¿

#### 1. ä¸»ä»ªè¡¨æ¿é…ç½®
```json
{
  "dashboard": {
    "title": "Keycloak Identity Service",
    "tags": ["keycloak", "identity", "security"],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "panels": [
      {
        "title": "Login Success Rate",
        "type": "stat",
        "targets": [
          {
            "expr": "keycloak_login_success_rate",
            "legendFormat": "Success Rate"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "min": 0,
            "max": 1,
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "yellow", "value": 0.9},
                {"color": "green", "value": 0.95}
              ]
            }
          }
        }
      },
      {
        "title": "Active Sessions",
        "type": "graph",
        "targets": [
          {
            "expr": "keycloak_active_sessions_current",
            "legendFormat": "Active Sessions"
          }
        ]
      },
      {
        "title": "Response Time Distribution",
        "type": "heatmap",
        "targets": [
          {
            "expr": "rate(keycloak_request_duration_seconds_bucket[5m])",
            "format": "heatmap",
            "legendFormat": "{{le}}"
          }
        ]
      }
    ]
  }
}
```

---

## å¼€å‘æŒ‡å—

### ğŸš€ å¿«é€Ÿå¼€å§‹

#### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/smarthub-identity-service.git
cd smarthub-identity-service

# ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®å¿…è¦å˜é‡

# å¯åŠ¨ä¾èµ–æœåŠ¡
docker-compose up -d postgres redis

# ç­‰å¾…æ•°æ®åº“å¯åŠ¨
./scripts/wait-for-postgres.sh

# å¯åŠ¨ Keycloak
docker-compose up keycloak
```

#### 2. åˆå§‹åŒ–é…ç½®
```bash
# å¯¼å…¥ Realm é…ç½®
./scripts/import-realm.sh

# åˆ›å»ºæµ‹è¯•ç”¨æˆ·
./scripts/create-test-users.sh

# éªŒè¯é…ç½®
curl -X GET "http://localhost:8080/auth/realms/smarthome/.well-known/openid_configuration"
```

### ğŸ”§ è‡ªå®šä¹‰å¼€å‘

#### 1. è‡ªå®šä¹‰ SPI å¼€å‘
```java
// è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨
public class SmartHubEventListenerProviderFactory implements EventListenerProviderFactory {
    
    @Override
    public EventListenerProvider create(KeycloakSession session) {
        return new SmartHubEventListenerProvider(session);
    }
    
    @Override
    public String getId() {
        return "smarthub-event-listener";
    }
    
    @Override
    public void init(Config.Scope config) {
        // åˆå§‹åŒ–é…ç½®
    }
}

// æ³¨å†Œ SPI
// META-INF/services/org.keycloak.events.EventListenerProviderFactory
com.smarthub.keycloak.SmartHubEventListenerProviderFactory
```

#### 2. è‡ªå®šä¹‰ä¸»é¢˜å¼€å‘
```css
/* themes/smarthub/login/resources/css/login.css */
.login-pf {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-pf-page .card-pf {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.btn-primary {
    background-color: #667eea;
    border-color: #667eea;
}

.btn-primary:hover {
    background-color: #5a6fd8;
    border-color: #5a6fd8;
}
```

#### 3. æ‰©å±• API å¼€å‘
```java
@RestController
@RequestMapping("/auth/api/v1")
public class IdentityExtensionController {
    
    @Autowired
    private UserProfileService userProfileService;
    
    @GetMapping("/users/{userId}/profile")
    public ResponseEntity<UserProfile> getUserProfile(@PathVariable String userId) {
        UserProfile profile = userProfileService.getUserProfile(userId);
        return ResponseEntity.ok(profile);
    }
    
    @PutMapping("/users/{userId}/profile")
    public ResponseEntity<UserProfile> updateUserProfile(
            @PathVariable String userId,
            @RequestBody UpdateProfileRequest request) {
        UserProfile updated = userProfileService.updateProfile(userId, request);
        return ResponseEntity.ok(updated);
    }
    
    @PostMapping("/users/{userId}/platform-bindings")
    public ResponseEntity<PlatformBinding> bindPlatform(
            @PathVariable String userId,
            @RequestBody BindPlatformRequest request) {
        PlatformBinding binding = userProfileService.bindPlatform(userId, request);
        return ResponseEntity.ok(binding);
    }
}
```

### ğŸ§ª æµ‹è¯•æŒ‡å—

#### 1. å•å…ƒæµ‹è¯•
```java
@ExtendWith(MockitoExtension.class)
class UserProfileServiceTest {
    
    @Mock
    private UserProfileRepository userProfileRepository;
    
    @InjectMocks
    private UserProfileService userProfileService;
    
    @Test
    void shouldUpdateUserProfile() {
        // Given
        String userId = "user-123";
        UpdateProfileRequest request = new UpdateProfileRequest();
        request.setPreferredLanguage("zh-CN");
        request.setTimezone("Asia/Shanghai");
        
        UserProfile existingProfile = new UserProfile();
        existingProfile.setUserId(userId);
        
        when(userProfileRepository.findByUserId(userId))
            .thenReturn(Optional.of(existingProfile));
        when(userProfileRepository.save(any(UserProfile.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));
        
        // When
        UserProfile result = userProfileService.updateProfile(userId, request);
        
        // Then
        assertThat(result.getPreferredLanguage()).isEqualTo("zh-CN");
        assertThat(result.getTimezone()).isEqualTo("Asia/Shanghai");
        verify(userProfileRepository).save(existingProfile);
    }
}
```

#### 2. é›†æˆæµ‹è¯•
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Testcontainers
class IdentityServiceIntegrationTest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:16")
            .withDatabaseName("keycloak_test")
            .withUsername("test")
            .withPassword("test");
    
    @Container
    static GenericContainer<?> keycloak = new GenericContainer<>("quay.io/keycloak/keycloak:26.0")
            .withExposedPorts(8080)
            .withEnv("KEYCLOAK_ADMIN", "admin")
            .withEnv("KEYCLOAK_ADMIN_PASSWORD", "admin")
            .dependsOn(postgres);
    
    @Test
    void shouldAuthenticateUserSuccessfully() {
        // å®ç° OAuth æµç¨‹æµ‹è¯•
        String authUrl = String.format("http://localhost:%d/auth/realms/smarthome/protocol/openid-connect/auth",
                keycloak.getMappedPort(8080));
        
        // æµ‹è¯•æˆæƒç æµç¨‹
        // ...
    }
}
```

#### 3. æ€§èƒ½æµ‹è¯•
```javascript
// k6 æ€§èƒ½æµ‹è¯•è„šæœ¬
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '30s', target: 100 },
    { duration: '1m', target: 200 },
    { duration: '30s', target: 0 },
  ],
};

export default function() {
  // æµ‹è¯•ç™»å½•æ€§èƒ½
  let loginResponse = http.post('http://localhost:8080/auth/realms/smarthome/protocol/openid-connect/token', {
    grant_type: 'password',
    client_id: 'test-client',
    username: 'testuser',
    password: 'testpass'
  });
  
  check(loginResponse, {
    'login successful': (r) => r.status === 200,
    'login response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
}
```

### ğŸ“š æ•…éšœæ’é™¤

#### 1. å¸¸è§é—®é¢˜
```yaml
common_issues:
  startup_failure:
    symptoms: "Keycloak å¯åŠ¨å¤±è´¥"
    causes:
      - "æ•°æ®åº“è¿æ¥å¤±è´¥"
      - "å†…å­˜ä¸è¶³"
      - "é…ç½®æ–‡ä»¶é”™è¯¯"
    solutions:
      - "æ£€æŸ¥æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²"
      - "å¢åŠ å®¹å™¨å†…å­˜é™åˆ¶"
      - "éªŒè¯ç¯å¢ƒå˜é‡é…ç½®"
      
  token_validation_error:
    symptoms: "Token éªŒè¯å¤±è´¥"
    causes:
      - "æ—¶é’Ÿä¸åŒæ­¥"
      - "JWKS ç¼“å­˜è¿‡æœŸ"
      - "Token è¿‡æœŸ"
    solutions:
      - "åŒæ­¥æœåŠ¡å™¨æ—¶é—´"
      - "æ¸…é™¤ JWKS ç¼“å­˜"
      - "æ£€æŸ¥ Token ç”Ÿå‘½å‘¨æœŸé…ç½®"
      
  performance_degradation:
    symptoms: "å“åº”æ—¶é—´è¿‡é•¿"
    causes:
      - "æ•°æ®åº“è¿æ¥æ± è€—å°½"
      - "å†…å­˜æ³„æ¼"
      - "å¤§é‡å¹¶å‘è¯·æ±‚"
    solutions:
      - "è°ƒæ•´è¿æ¥æ± å¤§å°"
      - "é‡å¯æœåŠ¡é‡Šæ”¾å†…å­˜"
      - "å¯ç”¨è¯·æ±‚é™æµ"
```

#### 2. è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹ Keycloak æ—¥å¿—
docker logs -f smarthub-keycloak

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec -it keycloak-postgres psql -U keycloak -d keycloak -c "SELECT count(*) FROM realm;"

# éªŒè¯ JWT Token
curl -X GET "http://localhost:8080/auth/realms/smarthome/protocol/openid-connect/certs" | jq .

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
docker stats smarthub-keycloak

# å¯¼å‡ºé…ç½®
docker exec smarthub-keycloak /opt/keycloak/bin/kc.sh export --realm smarthome --file /tmp/realm-export.json
```

---

## ğŸ”— ç›¸å…³é“¾æ¥

- **Keycloak å®˜æ–¹æ–‡æ¡£**: https://www.keycloak.org/documentation
- **OAuth 2.0 RFC**: https://tools.ietf.org/html/rfc6749
- **OpenID Connect è§„èŒƒ**: https://openid.net/connect/
- **JWT è§„èŒƒ**: https://tools.ietf.org/html/rfc7519
- **é¡¹ç›®ä»“åº“**: https://github.com/your-org/smarthub-identity-service

---

**ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024-01-01  
**ç»´æŠ¤è€…**: SmartHub å¼€å‘å›¢é˜Ÿ
