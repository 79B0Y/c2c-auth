```mermaid
graph LR

%% =========================
%% 7 个区域：GH / Alexa / Keycloak / Actix / n8n / LinknLink 设备 / 需开发程序
%% =========================

%% ---------- 1) Google Home ----------
subgraph GH[1) Google Home]
  GH_AL[Account Linking]
  GH_SH[Smart Home Graph\n(C2C 调用)]
  GH_LR[Local Home Runtime\n(加载本地 JS)]
end

%% ---------- 2) Alexa ----------
subgraph AX[2) Alexa]
  AX_AL[Account Linking]
  AX_SK[Smart Home Skill\n(Directive 调用)]
end

%% ---------- 3) Keycloak ----------
subgraph KC[3) Keycloak]
  KC_AUTH[/authorize]
  KC_TOKEN[/token]
  KC_JWKS[[JWKS / certs]]
  KC_RC[(Realm & Clients\ngoogle-smart-home\n/alexa-smart-home)]
end

%% ---------- 4) Actix ----------
subgraph ACT[4) Actix]
  ACT_G[Google Fulfillment\n/SYNC /QUERY /EXECUTE]
  ACT_A[Alexa Fulfillment\n/Discovery /Report /Control]
  ACT_JWT[JWT 校验\n(JWKS 缓存, iss/aud 校验)]
  ACT_IDEMP[幂等 & 超时 & 限流]
  ACT_CDATA[customData 生成\n(endpoint/auth/cap)]
  ACT_API[内部 API\n/devices /command]
end

%% ---------- 5) n8n ----------
subgraph N8[5) n8n]
  N8_REL[Local App 发布\n(构建/上传/灰度)]
  N8_RB[一键回滚]
  N8_MET[指标守门\n(P95/错误率/回落率)]
  N8_SYNC[设备同步\n(清单/触发 SYNC)]
  N8_RETRY[失败补偿\n(重试/DLQ/通知)]
end

%% ---------- 6) LinknLink 设备 ----------
subgraph LLK[6) LinknLink 设备侧]
  LLK_ISG[iSG 网关]
  LLK_ADP[协议适配\n(MQTT/HTTP/蓝牙)]
  LLK_DEV[局域网设备]
end

%% ---------- 7) 额外需要开发的程序 ----------
subgraph NEW[7) 需开发程序]
  NEW_DS[llk-device-service\n(设备/状态服务)]
  NEW_LH[llk-localhome-app\n(Google Local JS)]
  NEW_EDGE[llk-edge-adapter\n(运行于 iSG, 协议桥)]
  NEW_METRICS[llk-metrics-agent\n(指标/日志采集)]
end

%% =========================
%% 关系（跨区域）
%% =========================

%% OAuth 账号链接
GH_AL --> KC_AUTH
AX_AL --> KC_AUTH
KC_TOKEN --> GH_AL
KC_TOKEN --> AX_AL

%% Fulfillment 云端调用
GH_SH --> ACT_G
AX_SK --> ACT_A

%% Actix 鉴权与 Keycloak
ACT_JWT --- KC_JWKS

%% Actix 与内部能力
ACT_G --> ACT_CDATA
ACT_G --> ACT_IDEMP
ACT_A --> ACT_IDEMP
ACT_API --> NEW_DS

%% 设备链路
NEW_DS --> LLK_ISG
LLK_ISG --> LLK_ADP
LLK_ADP --> LLK_DEV

%% 本地执行（Local Home）
GH_LR --> NEW_LH
NEW_LH --> LLK_DEV
NEW_LH -.失败回落.-> ACT_G

%% n8n 编排
N8_REL --> NEW_LH
N8_RB  --> NEW_LH
N8_MET --> ACT_API
N8_SYNC --> ACT_API
N8_RETRY --> ACT_API

%% 监测与采集
NEW_METRICS --> ACT_API
NEW_METRICS --> NEW_DS
NEW_METRICS --> LLK_ISG

%% 样式
classDef box fill:#e8f3ff,stroke:#3b82f6,stroke-width:1px
classDef area fill:#fffced,stroke:#999,stroke-width:1px
class GH_AL,GH_SH,GH_LR,AX_AL,AX_SK,KC_AUTH,KC_TOKEN,KC_JWKS,KC_RC,ACT_G,ACT_A,ACT_JWT,ACT_IDEMP,ACT_CDATA,ACT_API,N8_REL,N8_RB,N8_MET,N8_SYNC,N8_RETRY,LLK_ISG,LLK_ADP,LLK_DEV,NEW_DS,NEW_LH,NEW_EDGE,NEW_METRICS box
class GH,AX,KC,ACT,N8,LLK,NEW area
```
