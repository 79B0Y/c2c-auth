```mermaid
graph LR

%% 必须有这个空行才能在 GitHub Mermaid 渲染

%% 区域 1: Google Home
subgraph GH1 [1) Google Home]
  GApp[Google Home App / Cloud]
  GLocal[Nest Hub / Local Home Runtime]
end

%% 区域 2: Alexa
subgraph AX2 [2) Alexa]
  AApp[Alexa App / Cloud]
end

%% 区域 3: Keycloak
subgraph KC3 [3) Keycloak]
  KCAuth[OAuth2 / OIDC IdP]
  KCToken[Access / Refresh Token]
end

%% 区域 4: Actix
subgraph ACTX4 [4) Actix Web]
  Fulfill[Fulfillment API: SYNC / QUERY / EXECUTE / Discovery / Control]
  Auth[JWT 验签 / 租户 / 限流 / 幂等]
  State[状态存储 / Redis 缓存]
end

%% 区域 5: N8N
subgraph N8N5 [5) n8n 编排]
  Workflow[发布 / 灰度 / 回滚 / 失败补偿]
  Metrics[指标守门 / 审计 / 报表]
end

%% 区域 6: LinknLink 设备
subgraph LNL6 [6) LinknLink 设备 / 网关]
  GW[iSG / 网关]
  DEV[局域网设备]
end

%% 区域 7: 额外开发的程序
subgraph EXTRA7 [7) 额外开发]
  LocalJS[Local Home JS (local_app.js)]
  Adapter[设备适配器: MQTT / HTTP / 蓝牙]
end

%% 连接关系
GApp -->|Account Linking| KCAuth
AApp -->|Account Linking| KCAuth
KCAuth -->|Token| GApp
KCAuth -->|Token| AApp

GApp -->|Bearer JWT| Fulfill
AApp -->|Bearer JWT| Fulfill

Fulfill --> Auth
Auth --> State
Fulfill --> Adapter
Adapter --> GW
GW --> DEV

GLocal -->|加载 JS| LocalJS
LocalJS -->|本地控制| DEV
LocalJS -.失败回落.-> Fulfill

N8N5 --> Workflow
N8N5 --> Metrics
Workflow --> LocalJS
Metrics --> Fulfill

classDef svc fill:#e8f3ff,stroke:#3b82f6,stroke-width:1px
classDef store fill:#fff7ed,stroke:#f59e0b,stroke-width:1px
class KCAuth,KCToken,Fulfill,Auth,State,Workflow,Metrics,LocalJS,Adapter,GApp,AApp,GLocal,GW,DEV svc
```
