```mermaid
graph LR

%% —— 保证此行后有空行（GitHub 需要换行） ——

%% 1) Google Home
subgraph GH[1) Google Home]
  GApp[Google Home App / Cloud]
  GLocal[Nest Hub / Local Home Runtime]
end

%% 2) Alexa
subgraph AX[2) Alexa]
  AApp[Alexa App / Cloud]
end

%% 3) Keycloak
subgraph KC[3) Keycloak]
  KCAuth[/authorize & /token/]
  KCJWKS[[JWKS /certs]]
end

%% 4) Actix
subgraph AC[4) Actix]
  Fulfill[Fulfillment: SYNC/QUERY/EXECUTE\n& Discovery/Control]
  Auth[JWT 验签 (iss/aud/kid)]
  Idem[幂等/限流/超时]
  API[内部 API /devices /command]
end

%% 5) n8n
subgraph N8[5) n8n]
  Rel[Local JS 发布/灰度/回滚]
  Retry[失败补偿/DLQ]
  Metrics[指标守门/审计]
end

%% 6) LinknLink 设备
subgraph LLK[6) LinknLink 设备]
  GW[iSG/网关]
  DEV[局域网设备]
end

%% 7) 需开发程序
subgraph NEW[7) 需开发程序]
  LocalJS[llk-localhome-app\n(local_app.js)]
  Adapter[llk-edge-adapter\n(设备协议桥: MQTT/HTTP/BT)]
  DevSvc[llk-device-service\n(设备/状态服务)]
end

%% —— 关系 ——
GApp -->|Account Linking| KCAuth
AApp -->|Account Linking| KCAuth
KCAuth -->|Token/JWT| GApp
KCAuth -->|Token/JWT| AApp
KCJWKS --> Auth

GApp -->|Bearer JWT| Fulfill
AApp -->|Bearer JWT| Fulfill
Fulfill --> Auth
Auth --> Idem
Fulfill --> API
API --> DevSvc
DevSvc --> Adapter
Adapter --> GW
GW --> DEV

GLocal -->|加载 JS| LocalJS
LocalJS -->|本地控制| DEV
LocalJS -.失败回落.-> Fulfill

N8 --> Rel
N8 --> Retry
N8 --> Metrics
Rel --> LocalJS
Retry --> API
Metrics --> API

classDef svc fill:#e8f3ff,stroke:#3b82f6,stroke-width:1px
classDef store fill:#fff7ed,stroke:#f59e0b,stroke-width:1px
class GApp,GLocal,AApp,KCAuth,KCJWKS,Fulfill,Auth,Idem,API,Rel,Retry,Metrics,GW,DEV,LocalJS,Adapter,DevSvc svc
```
